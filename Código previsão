## Importando e separando os dados do INMET
### Importando e separando dados do INMET
#Definindo período dos dados
AnoI=2019
AnoF=2022
Mes="04"
DiaF=25

#Imports
import requests
import pandas as pd
import json

#reset de variável
dados_filtrados=0

#Anos loop request
for Ano in range(AnoI, AnoF):
  url = "https://apitempo.inmet.gov.br/estacao/"+str(Ano)+"-"+Mes+"-"+str(DiaF+1)+"/"+str(Ano+1)+"-"+Mes+"-"+str(DiaF)+"/A201"
  resultado = requests.get(url)
  dados = resultado.json()
  ##Convertendo em um DataFrame e filtrando
  dados_str = json.dumps(dados)
  dados_tabela = pd.read_json(dados_str)
  dados_tabela_separados = dados_tabela[["DT_MEDICAO","HR_MEDICAO","RAD_GLO","TEM_INS","UMD_INS"]]
  #Verifica se dados_filtrados já tem uma tabela
  if (type(dados_filtrados) is int):
    dados_filtrados = dados_tabela_separados
  else:
    dados_filtrados = pd.DataFrame(dados_filtrados)
    dados_tabela_separados = pd.DataFrame(dados_tabela_separados)
    ds = [dados_filtrados, dados_tabela_separados]
    #Junção das tabelas
    dados_filtrados = pd.concat(ds, ignore_index=True)

print(dados_filtrados)



### Lidando com NAs e ajustando dados
#### Umidade
import matplotlib.pyplot as plt


#Coluna umidade com NAs
coluna_umidade_cNAs = dados_filtrados[["UMD_INS"]]
#Numero de NAs
print("Numero de NAs na umidade",coluna_umidade_cNAs.isna().sum())
#Correção linear de NAs
coluna_umidade = coluna_umidade_cNAs.interpolate(method="linear")
#Numero de NAs final 
print("Numero de NAs na umidade",coluna_umidade.isna().sum())

#Gráficos de NAS
#coluna_umidade_cNAs.plot(figsize=(22,4), label="original")
#coluna_umidade.plot(figsize=(22,4),style=["--"],label="Com correção linear")
#plt.legend()
#print(coluna_umidade)

#Atribuição final
import numpy as np
import datetime
#Umidade
inicio = str(AnoI)+"-"+Mes+"-"+str(DiaF+1)
indice = pd.date_range(inicio, freq = 'H', periods = len(coluna_umidade[["UMD_INS"]]))

umidade = coluna_umidade[["UMD_INS"]]
umidade.index = indice
#umidade



#### Temperatura
#Coluna temperatura com NAs
coluna_temperatura_cNAs = dados_filtrados[["TEM_INS"]]
#Numero de NAs
print("Numero de NAs na temperatura",coluna_temperatura_cNAs.isna().sum())
#Correção linear de NAs
coluna_temperatura = coluna_temperatura_cNAs.interpolate(method="linear")
#Numero de NAs final 
print("Numero de NAs na temperatura",coluna_temperatura.isna().sum())

#Gráficos de NAS
#coluna_temperatura_cNAs.plot(figsize=(22,4), label="original")
#coluna_temperatura.plot(figsize=(22,4),style=["--"],label="Com correção linear")
#plt.legend()
#print(coluna_temperatura)

#Atribuição final
#temperatura
temperatura = coluna_temperatura[["TEM_INS"]]
temperatura.index = indice
#temperatura



#### Radiação
def correct_neg(x):
  if (type(x)==str):
    return x
  else:
    if (x<0):
      return 0
    else:
      return x

#Coluna radiação com NAs
coluna_radiacao_cNAs_0 = dados_filtrados[["RAD_GLO"]]
#Correção de números negativos
#fazer coluna_radiacao_cNAs = x for x em coluna_radiacao_0 se um dos elementos de coluna for maior que 0, se não igualar a zero
coluna_radiacao_cNAs_0["RAD_GLO"] = [correct_neg(x) for x in coluna_radiacao_cNAs_0["RAD_GLO"]]
#print(coluna_radiacao_cNAs_0)
coluna_radiacao_cNAs = coluna_radiacao_cNAs_0

#Numero de NAs
print("Numero de NAs na radiação",coluna_radiacao_cNAs.isna().sum())
#Correção linear de NAs
coluna_radiacao = coluna_radiacao_cNAs.interpolate(method="linear")
#Numero de NAs final 
print("Numero de NAs na radiação",coluna_radiacao.isna().sum())

#Gráficos de NAS
#coluna_radiacao_cNAs.plot(figsize=(22,4), label="original")
#coluna_radiacao.plot(figsize=(22,4),style=["--"],label="Com correção linear")
#plt.legend()
#print(coluna_radiacao)

#temperatura
radiacao = coluna_radiacao[["RAD_GLO"]]
radiacao.index = indice
#radiacao



## Análise dos dados
### Umidade 
print(umidade)


### Temperatura
print(temperatura)


### Radiação (falta alterar)(ajustar os dados e fazer a análise gráfica e testes com arima)
print(radiação)

